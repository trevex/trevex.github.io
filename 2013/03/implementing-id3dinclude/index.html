<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Nik Voss - Implementing ID3DInclude</title><link rel="stylesheet" href="http://127.0.0.1:4000/css/style.css"/><link rel="alternate" type="application/rss+xml" title="Nik Voss" href="http://127.0.0.1:4000/feed.xml"><link rel="canonical" href="http://127.0.0.1:4000/2013/03/implementing-id3dinclude/"/><link rel="prev" title="Three.js simple grass rendering" href="http://127.0.0.1:4000/2013/02/threejs-grass-rendering/"/><link rel="next" title="Crowd-Simulation Resources" href="http://127.0.0.1:4000/2013/03/crowd-sim-resources/"/></head><body> <header id="menu"><div class="hcenter"><div class="left title"> <a href="http://127.0.0.1:4000"><img src="http://127.0.0.1:4000/img/nik_voss.png" alt="Programmer's diary"/></a></div><ul class="right"><li><a href="/portfolio.html">Portfolio</a></li><li><a href="/index.html">Blog</a></li><li><a href="#contact">Contact</a></li><li><a href="#aboutme">About</a></li></ul></div> </header><div id="content" class="hcenter"> <article> <header><h1>Implementing ID3DInclude</h1> <time datetime="2013-03-07">March 7, 2013</time> </header> <section class="justify"><p>For the procedural methods coursework I am currently working on I wrote a small framework to hide away the DirectX API completely and make it easier to use and simpler to prototype with. The procedural real-time terrain generation is running on the GPU and therefore heavily relying on Shaders.</p><p>To keep everything lightweight I wanted to depend on the minimum on dependencies, so mainly DirectX 11 obviously, but also the nice header-only math library GLM. At some point I encountered the problem that the Shaders were getting more complex and therefore I wanted to split the code in multiple files (especially the noise and fractal functions) to make them easier to maintain and reuse. To allow shader files that get compiled on runtime to include files the ID3DInclude-Interface has to be implemented. I stumbled upon a nice article by Adam Sawicki, that helped me a lot. Since his code was depending on his own framework, I thought I share the no-dependencies version of a ID3DInclude-Interface implementation.</p><p>Header-file:</p><div class='highlight'><pre><code class='cpp'><span class='k'>class</span> <span class='nc'>CShaderInclude</span> <span class='o'>:</span> <span class='k'>public</span> <span class='n'>ID3DInclude</span> <span class='p'>{</span>
<span class='nl'>public:</span>
    <span class='n'>CShaderInclude</span><span class='p'>(</span><span class='k'>const</span> <span class='kt'>char</span><span class='o'>*</span> <span class='n'>shaderDir</span><span class='p'>,</span> <span class='k'>const</span> <span class='kt'>char</span><span class='o'>*</span> <span class='n'>systemDir</span><span class='p'>)</span> <span class='o'>:</span> <span class='n'>m_ShaderDir</span><span class='p'>(</span><span class='n'>shaderDir</span><span class='p'>),</span> <span class='n'>m_SystemDir</span><span class='p'>(</span><span class='n'>systemDir</span><span class='p'>)</span> <span class='p'>{}</span>

    <span class='n'>HRESULT</span> <span class='kr'>__stdcall</span> <span class='n'>Open</span><span class='p'>(</span><span class='n'>D3D_INCLUDE_TYPE</span> <span class='n'>IncludeType</span><span class='p'>,</span> <span class='n'>LPCSTR</span> <span class='n'>pFileName</span><span class='p'>,</span> <span class='n'>LPCVOID</span> <span class='n'>pParentData</span><span class='p'>,</span> <span class='n'>LPCVOID</span> <span class='o'>*</span><span class='n'>ppData</span><span class='p'>,</span> <span class='n'>UINT</span> <span class='o'>*</span><span class='n'>pBytes</span><span class='p'>);</span>
    <span class='n'>HRESULT</span> <span class='kr'>__stdcall</span> <span class='nf'>Close</span><span class='p'>(</span><span class='n'>LPCVOID</span> <span class='n'>pData</span><span class='p'>);</span>
<span class='nl'>private:</span>
    <span class='n'>std</span><span class='o'>::</span><span class='n'>string</span> <span class='n'>m_ShaderDir</span><span class='p'>;</span>
    <span class='n'>std</span><span class='o'>::</span><span class='n'>string</span> <span class='n'>m_SystemDir</span><span class='p'>;</span>
<span class='p'>};</span>
</code></pre></div><p>Source-file:</p><div class='highlight'><pre><code class='cpp'><span class='k'>const</span> <span class='kt'>char</span><span class='o'>*</span> <span class='n'>gSystemDir</span> <span class='o'>=</span> <span class='s'>"..</span><span class='se'>\</span><span class='s'>Shader"</span><span class='p'>;</span>

<span class='n'>HRESULT</span> <span class='kr'>__stdcall</span> <span class='n'>CShaderInclude</span><span class='o'>::</span><span class='n'>Open</span><span class='p'>(</span><span class='n'>D3D_INCLUDE_TYPE</span> <span class='n'>IncludeType</span><span class='p'>,</span> <span class='n'>LPCSTR</span> <span class='n'>pFileName</span><span class='p'>,</span> <span class='n'>LPCVOID</span> <span class='n'>pParentData</span><span class='p'>,</span> <span class='n'>LPCVOID</span> <span class='o'>*</span><span class='n'>ppData</span><span class='p'>,</span> <span class='n'>UINT</span> <span class='o'>*</span><span class='n'>pBytes</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='n'>try</span> <span class='p'>{</span>
        <span class='n'>std</span><span class='o'>::</span><span class='n'>string</span> <span class='n'>finalPath</span><span class='p'>;</span>
        <span class='k'>switch</span><span class='p'>(</span><span class='n'>IncludeType</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='k'>case</span> <span class='n'>D3D_INCLUDE_LOCAL</span>:
            <span class='n'>finalPath</span> <span class='o'>=</span> <span class='n'>m_ShaderDir</span> <span class='o'>+</span> <span class='s'>"</span><span class='se'>\</span><span class='s'>"</span> <span class='o'>+</span> <span class='n'>pFileName</span><span class='p'>;</span>
            <span class='k'>break</span><span class='p'>;</span>
        <span class='k'>case</span> <span class='n'>D3D_INCLUDE_SYSTEM</span>:
            <span class='n'>finalPath</span> <span class='o'>=</span> <span class='n'>m_SystemDir</span> <span class='o'>+</span> <span class='s'>"</span><span class='se'>\</span><span class='s'>"</span> <span class='o'>+</span> <span class='n'>pFileName</span><span class='p'>;</span>
            <span class='k'>break</span><span class='p'>;</span>
        <span class='nl'>default:</span>
            <span class='n'>assert</span><span class='p'>(</span><span class='mi'>0</span><span class='p'>);</span>
        <span class='p'>}</span>

        <span class='n'>std</span><span class='o'>::</span><span class='n'>ifstream</span> <span class='n'>includeFile</span><span class='p'>(</span><span class='n'>finalPath</span><span class='p'>.</span><span class='n'>c_str</span><span class='p'>(),</span> <span class='n'>std</span><span class='o'>::</span><span class='n'>ios</span><span class='o'>::</span><span class='n'>in</span><span class='o'>|</span><span class='n'>std</span><span class='o'>::</span><span class='n'>ios</span><span class='o'>::</span><span class='n'>binary</span><span class='o'>|</span><span class='n'>std</span><span class='o'>::</span><span class='n'>ios</span><span class='o'>::</span><span class='n'>ate</span><span class='p'>);</span>

        <span class='k'>if</span> <span class='p'>(</span><span class='n'>includeFile</span><span class='p'>.</span><span class='n'>is_open</span><span class='p'>())</span> <span class='p'>{</span>
            <span class='kt'>long</span> <span class='kt'>long</span> <span class='n'>fileSize</span> <span class='o'>=</span> <span class='n'>includeFile</span><span class='p'>.</span><span class='n'>tellg</span><span class='p'>();</span>
            <span class='kt'>char</span><span class='o'>*</span> <span class='n'>buf</span> <span class='o'>=</span> <span class='k'>new</span> <span class='kt'>char</span><span class='p'>[</span><span class='n'>fileSize</span><span class='p'>];</span>
            <span class='n'>includeFile</span><span class='p'>.</span><span class='n'>seekg</span> <span class='p'>(</span><span class='mi'>0</span><span class='p'>,</span> <span class='n'>std</span><span class='o'>::</span><span class='n'>ios</span><span class='o'>::</span><span class='n'>beg</span><span class='p'>);</span>
            <span class='n'>includeFile</span><span class='p'>.</span><span class='n'>read</span> <span class='p'>(</span><span class='n'>buf</span><span class='p'>,</span> <span class='n'>fileSize</span><span class='p'>);</span>
            <span class='n'>includeFile</span><span class='p'>.</span><span class='n'>close</span><span class='p'>();</span>
            <span class='o'>*</span><span class='n'>ppData</span> <span class='o'>=</span> <span class='n'>buf</span><span class='p'>;</span>
            <span class='o'>*</span><span class='n'>pBytes</span> <span class='o'>=</span> <span class='n'>fileSize</span><span class='p'>;</span>
        <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
            <span class='k'>return</span> <span class='n'>E_FAIL</span><span class='p'>;</span>
        <span class='p'>}</span>
        <span class='k'>return</span> <span class='n'>S_OK</span><span class='p'>;</span>
    <span class='p'>}</span>
    <span class='k'>catch</span><span class='p'>(</span><span class='n'>std</span><span class='o'>::</span><span class='n'>exception</span><span class='o'>&amp;</span> <span class='n'>e</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='k'>return</span> <span class='n'>E_FAIL</span><span class='p'>;</span>
    <span class='p'>}</span>
<span class='p'>}</span>

<span class='n'>HRESULT</span> <span class='kr'>__stdcall</span> <span class='n'>CShaderInclude</span><span class='o'>::</span><span class='n'>Close</span><span class='p'>(</span><span class='n'>LPCVOID</span> <span class='n'>pData</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='kt'>char</span><span class='o'>*</span> <span class='n'>buf</span> <span class='o'>=</span> <span class='p'>(</span><span class='kt'>char</span><span class='o'>*</span><span class='p'>)</span><span class='n'>pData</span><span class='p'>;</span>
    <span class='k'>delete</span><span class='p'>[]</span> <span class='n'>buf</span><span class='p'>;</span>
    <span class='k'>return</span> <span class='n'>S_OK</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre></div></section><div id="disqus_thread"></div> <script>var disqus_shortname="nikvoss";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </article></div> <footer id="info"><div class="hcenter"> <section id="contact" class="left"><h1>Contact</h1> <a href="https://twitter.com/niktehpui" title="Twitter"><div class="icon twitter"></div></a> <a href="https://github.com/trevex/" title="Github"><div class="icon github"></div></a> <a href="mailto:niklas.voss@gmail.com" title="Mail"><div class="icon mail"></div></a> <a href="https://plus.google.com/+NiklasVoss/auto" title="Google+"><div class="icon gplus"></div></a> </section> <section id="aboutme" class="justify right"><h1>About me</h1> Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec vitae odio est, sed pretium tortor. Proin sed turpis elit. Pellentesque et iaculis sapien. Nulla in lorem vel neque lobortis ornare. Phasellus vitae augue eu leo ullamcorper tincidunt ut at metus. Sed molestie porttitor lacus, a tincidunt leo convallis ac. Aenean nulla turpis, laoreet ac feugiat quis, condimentum non nulla. Donec egestas lobortis facilisis. Vivamus aliquam mattis nisi id commodo. </section><div class="clear"></div></div> </footer> <section id="copyright"> © Nik Voss </section></body></html>